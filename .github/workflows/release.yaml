name: Release

on:
  push:
    tags: ["v[0-9]+.*"]

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  BINARY_NAME: lazylora

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: taiki-e/create-gh-release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  publish-crate:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_API_TOKEN }}
        run: |
          cargo publish --dry-run
          cargo publish

  upload-assets:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: x86_64-pc-windows-msvc
            os: windows-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
          - target: aarch64-apple-darwin
            os: macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation dependencies
        if: matrix.target == 'x86_64-unknown-linux-musl' || contains(matrix.target, 'musl')
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools musl-dev

      - name: Install cross-compilation dependencies for aarch64
        if: contains(matrix.target, 'aarch64') && matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Set cross-compilation environment
        if: contains(matrix.target, 'aarch64-unknown-linux-gnu')
        run: |
          echo "CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - uses: taiki-e/upload-rust-binary-action@v1
        with:
          bin: ${{ env.BINARY_NAME }}
          target: ${{ matrix.target }}
          features: vendored-openssl
          include: LICENSE,README.md
          checksum: sha256
          token: ${{ secrets.GITHUB_TOKEN }}

  test-installation:
    needs: upload-assets
    continue-on-error: true
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Test script installation
        if: runner.os != 'Windows'
        shell: bash
        run: |
          sleep 30
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/install.sh | bash -s -- --version ${{ github.ref_name }}
          
          if command -v lazylora >/dev/null 2>&1; then
            lazylora help
            lazylora version
          elif [ -f "/usr/local/bin/lazylora" ]; then
            /usr/local/bin/lazylora help
          elif [ -f "$HOME/.local/bin/lazylora" ]; then
            $HOME/.local/bin/lazylora help
          else
            echo "Installation failed"
            exit 1
          fi

      - name: Test update check
        if: runner.os != 'Windows'
        shell: bash
        run: |
          LAZYLORA_BIN=""
          if command -v lazylora >/dev/null 2>&1; then
            LAZYLORA_BIN="lazylora"
          elif [ -f "/usr/local/bin/lazylora" ]; then
            LAZYLORA_BIN="/usr/local/bin/lazylora"
          elif [ -f "$HOME/.local/bin/lazylora" ]; then
            LAZYLORA_BIN="$HOME/.local/bin/lazylora"
          fi
          
          if [ -n "$LAZYLORA_BIN" ]; then
            echo "Testing update check functionality..."
            $LAZYLORA_BIN update 2>&1 | tee update_output.txt
            if grep -q "You are using the latest version\|Current version:" update_output.txt; then
              echo "Update check works correctly"
            else
              echo "Update check failed"
              exit 1
            fi
          fi

      - name: Test script installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Start-Sleep -Seconds 30
          $script = iwr "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/install.ps1"
          $scriptBlock = [ScriptBlock]::Create($script.Content)
          & $scriptBlock -Version "${{ github.ref_name }}"
          
          $binaryPath = "$env:LOCALAPPDATA\Programs\lazylora\lazylora.exe"
          if (Test-Path $binaryPath) {
            & $binaryPath help
            & $binaryPath version
          } elseif (Get-Command lazylora -ErrorAction SilentlyContinue) {
            lazylora help
            lazylora version
          } else {
            throw "Installation failed"
          }

      - name: Test update check (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $binaryPath = "$env:LOCALAPPDATA\Programs\lazylora\lazylora.exe"
          $lazylora = $null
          
          if (Test-Path $binaryPath) {
            $lazylora = $binaryPath
          } elseif (Get-Command lazylora -ErrorAction SilentlyContinue) {
            $lazylora = "lazylora"
          }
          
          if ($lazylora) {
            Write-Host "Testing update check functionality..."
            $output = & $lazylora update 2>&1 | Out-String
            Write-Host $output
            if ($output -match "You are using the latest version|Current version:") {
              Write-Host "Update check works correctly"
            } else {
              throw "Update check failed"
            }
          }

  test-upgrade:
    needs: upload-assets
    continue-on-error: true
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Get previous release tag
        id: prev_release
        shell: bash
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          echo "Current release tag: $CURRENT_TAG"
          
          # Get all tags sorted by version (semver), exclude current tag, pick the most recent one before current
          # Using git ls-remote to get tags directly, then sort by version
          PREV_TAG=$(git ls-remote --tags --sort=-v:refname "https://github.com/${{ github.repository }}.git" | \
            grep -o 'refs/tags/v[0-9]*\.[0-9]*\.[0-9]*$' | \
            sed 's|refs/tags/||' | \
            grep -v "^${CURRENT_TAG}$" | \
            head -n 1)
          
          if [ -z "$PREV_TAG" ]; then
            echo "No previous release found, skipping upgrade test"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Previous release tag: $PREV_TAG"
            echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Install previous release (Unix)
        if: runner.os != 'Windows' && steps.prev_release.outputs.skip != 'true'
        shell: bash
        run: |
          PREV_TAG="${{ steps.prev_release.outputs.prev_tag }}"
          echo "Installing previous release: $PREV_TAG"
          
          # Install previous version using the install script from that release
          curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/${PREV_TAG}/install.sh" | bash -s -- --version "$PREV_TAG"
          
          # Find and verify the installed binary
          LAZYLORA_BIN=""
          if command -v lazylora >/dev/null 2>&1; then
            LAZYLORA_BIN="lazylora"
          elif [ -f "/usr/local/bin/lazylora" ]; then
            LAZYLORA_BIN="/usr/local/bin/lazylora"
          elif [ -f "$HOME/.local/bin/lazylora" ]; then
            LAZYLORA_BIN="$HOME/.local/bin/lazylora"
          fi
          
          if [ -z "$LAZYLORA_BIN" ]; then
            echo "Failed to install previous release"
            exit 1
          fi
          
          # Verify previous version is installed
          echo "Verifying previous version installation..."
          INSTALLED_VERSION=$($LAZYLORA_BIN version 2>&1 || echo "")
          echo "Installed version output: $INSTALLED_VERSION"
          
          # Store the binary path for later steps
          echo "LAZYLORA_BIN=$LAZYLORA_BIN" >> $GITHUB_ENV
          echo "PREV_VERSION=$PREV_TAG" >> $GITHUB_ENV

      - name: Upgrade to new release (Unix)
        if: runner.os != 'Windows' && steps.prev_release.outputs.skip != 'true'
        shell: bash
        run: |
          sleep 30  # Wait for release assets to be fully available
          
          CURRENT_TAG="${{ github.ref_name }}"
          echo "Upgrading from ${{ env.PREV_VERSION }} to $CURRENT_TAG"
          
          # Install new version (should overwrite the previous one)
          curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/${CURRENT_TAG}/install.sh" | bash -s -- --version "$CURRENT_TAG"
          
          echo "Upgrade completed"

      - name: Verify upgrade and test binary (Unix)
        if: runner.os != 'Windows' && steps.prev_release.outputs.skip != 'true'
        shell: bash
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          CURRENT_VERSION="${CURRENT_TAG#v}"  # Remove 'v' prefix
          
          # Find the binary
          LAZYLORA_BIN=""
          if command -v lazylora >/dev/null 2>&1; then
            LAZYLORA_BIN="lazylora"
          elif [ -f "/usr/local/bin/lazylora" ]; then
            LAZYLORA_BIN="/usr/local/bin/lazylora"
          elif [ -f "$HOME/.local/bin/lazylora" ]; then
            LAZYLORA_BIN="$HOME/.local/bin/lazylora"
          fi
          
          if [ -z "$LAZYLORA_BIN" ]; then
            echo "Binary not found after upgrade"
            exit 1
          fi
          
          echo "Testing upgraded binary at: $LAZYLORA_BIN"
          
          # Test basic functionality
          echo "=== Testing 'help' command ==="
          $LAZYLORA_BIN help
          
          echo "=== Testing 'version' command ==="
          VERSION_OUTPUT=$($LAZYLORA_BIN version 2>&1)
          echo "$VERSION_OUTPUT"
          
          # Verify the version matches the new release
          if echo "$VERSION_OUTPUT" | grep -q "$CURRENT_VERSION"; then
            echo "Version verification passed: Binary reports version $CURRENT_VERSION"
          else
            echo "Warning: Version output does not contain expected version $CURRENT_VERSION"
            echo "This may be expected if version format differs"
          fi
          
          echo "=== Testing 'update' command ==="
          UPDATE_OUTPUT=$($LAZYLORA_BIN update 2>&1 || true)
          echo "$UPDATE_OUTPUT"
          
          if echo "$UPDATE_OUTPUT" | grep -q "You are using the latest version\|Current version:"; then
            echo "Update check works correctly after upgrade"
          else
            echo "Update check returned unexpected output"
          fi
          
          echo "=== Upgrade test completed successfully ==="

      - name: Install previous release (Windows)
        if: runner.os == 'Windows' && steps.prev_release.outputs.skip != 'true'
        shell: pwsh
        run: |
          $prevTag = "${{ steps.prev_release.outputs.prev_tag }}"
          Write-Host "Installing previous release: $prevTag"
          
          # Install previous version using the install script from that release
          $script = Invoke-WebRequest "https://raw.githubusercontent.com/${{ github.repository }}/${prevTag}/install.ps1"
          $scriptBlock = [ScriptBlock]::Create($script.Content)
          & $scriptBlock -Version "$prevTag"
          
          # Verify installation
          $binaryPath = "$env:LOCALAPPDATA\Programs\lazylora\lazylora.exe"
          if (Test-Path $binaryPath) {
            Write-Host "Previous version installed successfully"
            $versionOutput = & $binaryPath version 2>&1 | Out-String
            Write-Host "Installed version: $versionOutput"
          } elseif (Get-Command lazylora -ErrorAction SilentlyContinue) {
            Write-Host "Previous version installed successfully (found in PATH)"
            $versionOutput = lazylora version 2>&1 | Out-String
            Write-Host "Installed version: $versionOutput"
          } else {
            throw "Failed to install previous release"
          }

      - name: Upgrade to new release (Windows)
        if: runner.os == 'Windows' && steps.prev_release.outputs.skip != 'true'
        shell: pwsh
        run: |
          Start-Sleep -Seconds 30  # Wait for release assets to be fully available
          
          $currentTag = "${{ github.ref_name }}"
          Write-Host "Upgrading to $currentTag"
          
          # Install new version (should overwrite the previous one)
          $script = Invoke-WebRequest "https://raw.githubusercontent.com/${{ github.repository }}/${currentTag}/install.ps1"
          $scriptBlock = [ScriptBlock]::Create($script.Content)
          & $scriptBlock -Version "$currentTag"
          
          Write-Host "Upgrade completed"

      - name: Verify upgrade and test binary (Windows)
        if: runner.os == 'Windows' && steps.prev_release.outputs.skip != 'true'
        shell: pwsh
        run: |
          $currentTag = "${{ github.ref_name }}"
          $currentVersion = $currentTag -replace '^v', ''
          
          # Find the binary
          $binaryPath = "$env:LOCALAPPDATA\Programs\lazylora\lazylora.exe"
          $lazylora = $null
          
          if (Test-Path $binaryPath) {
            $lazylora = $binaryPath
          } elseif (Get-Command lazylora -ErrorAction SilentlyContinue) {
            $lazylora = "lazylora"
          }
          
          if (-not $lazylora) {
            throw "Binary not found after upgrade"
          }
          
          Write-Host "Testing upgraded binary at: $lazylora"
          
          # Test basic functionality
          Write-Host "=== Testing 'help' command ==="
          & $lazylora help
          
          Write-Host "=== Testing 'version' command ==="
          $versionOutput = & $lazylora version 2>&1 | Out-String
          Write-Host $versionOutput
          
          # Verify the version matches the new release
          if ($versionOutput -match [regex]::Escape($currentVersion)) {
            Write-Host "Version verification passed: Binary reports version $currentVersion"
          } else {
            Write-Host "Warning: Version output does not contain expected version $currentVersion"
            Write-Host "This may be expected if version format differs"
          }
          
          Write-Host "=== Testing 'update' command ==="
          $updateOutput = & $lazylora update 2>&1 | Out-String
          Write-Host $updateOutput
          
          if ($updateOutput -match "You are using the latest version|Current version:") {
            Write-Host "Update check works correctly after upgrade"
          } else {
            Write-Host "Update check returned unexpected output"
          }
          
          Write-Host "=== Upgrade test completed successfully ==="

  publish-aur:
    needs: [upload-assets, create-release]
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup environment variables
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          echo "RELEASE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Wait for binaries
        run: |
          sleep 60
          BINARY_URL="https://github.com/${{ github.repository }}/releases/download/v${{ env.VERSION }}/${{ env.BINARY_NAME }}-x86_64-unknown-linux-gnu.tar.gz"
          
          for i in {1..5}; do
            if curl -sSf --head "$BINARY_URL" > /dev/null; then
              echo "Binaries available"
              break
            else
              echo "Waiting for binaries... ($i/5)"
              sleep 30
            fi
            if [ $i -eq 5 ]; then
              echo "Binaries not available"
              exit 1
            fi
          done

      - name: Generate AUR PKGBUILD files
        run: |
          chmod +x scripts/generate-aur-pkgbuild.sh
          ./scripts/generate-aur-pkgbuild.sh \
            --version "${{ env.VERSION }}" \
            --output "./aur-packages" \
            --force

      - name: Publish source package to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: lazylora
          pkgbuild: ./aur-packages/PKGBUILD-source
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to version ${{ env.VERSION }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519

      - name: Publish binary package to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: lazylora-bin
          pkgbuild: ./aur-packages/PKGBUILD-bin
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to version ${{ env.VERSION }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
